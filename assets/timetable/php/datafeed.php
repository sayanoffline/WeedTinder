<?phpinclude_once("dbconfig.php");include_once("functions.php");function addCalendar($st, $et, $sub, $ade){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();	$dateAdded=gmdate('Y-m-d H:i:s');	$dateModified=gmdate('Y-m-d H:i:s');	$shst=php2MySqlTime(js2PhpTime($st));	$shet=php2MySqlTime(js2PhpTime($et));			$bth_sql="insert into schedules set `parent_id`='$_SESSION[userId]', `start_time`='$shst', `end_time`='$shet', `date_added`='$dateAdded', `date_modified`='$dateModified'";	mysql_query($bth_sql);		$scid=mysql_insert_id();    $sql = "insert into `jqcalendar` (`subject`, `schedule_id`, `starttime`, `endtime`, `isalldayevent`) values ('"      .mysql_real_escape_string($sub)."', '"      .mysql_real_escape_string($scid)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function addDetailedCalendar($st, $et, $bth, $ade, $schday, $color, $tz){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();	$bth_row=mysql_fetch_array(mysql_query("select * from batch where id='$bth'"));	if($bth_row['start_date']!="" || $bth_row['end_date']!="")	{	$startTimeExpVal=explode(' ',$bth_row['start_date']);	$endTimeExpVal=explode(' ',$bth_row['end_date']);	$stime=$startTimeExpVal[0]." ".$st;	$etime=$endTimeExpVal[0]." ".$et;	$flg_top=0;	if($schday=="")	{		$flg_top=1;	}	if($flg_top==0)	{		$flg=0;	$flg_in=0;		$dateAdded=gmdate('Y-m-d H:i:s');	$dateModified=gmdate('Y-m-d H:i:s');	$days = implode(',',$schday);	//$bth_row=mysql_fetch_array(mysql_query("select * from schedules where id='$bth'"));	$bth_sql="insert into schedules set `parent_id`='$_SESSION[userId]', `batch_id`='$bth', `schedule_days`='$days', `start_time`='$stime', `end_time`='$etime', `date_added`='$dateAdded', `date_modified`='$dateModified'";	mysql_query($bth_sql);		$scid=mysql_insert_id();			//$schArr[]=$schday;	foreach ($schday as $scheduleVal)	{		$endDate = strtotime($bth_row['end_date']);	$flg_in=1;			for($i = strtotime($scheduleVal, strtotime($bth_row['start_date'])); $i <= $endDate; $i = strtotime('+1 week', $i))    	{	$place=date('Y-m-d', $i);		$preSt=$place." ".$st;	$preEt=$place." ".$et;	$finalSt=date("Y-m-d H:i:s", strtotime($preSt));	$finalEt=date("Y-m-d H:i:s", strtotime($preEt));				    $sql = "insert into `jqcalendar` (`subject`, `schedule_id`, `batch_id`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"      .mysql_real_escape_string($bth_row['name'])."', '"      .$scid."', '"      .mysql_real_escape_string($bth)."', '"      .$finalSt."', '"      .$finalEt."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"      .mysql_real_escape_string($color)."' )";    mysql_query($sql);    //echo($sql);	$flg=1;	}	}		if($flg==1){	$ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }else{	if($flg_in==1)	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'You have select invalid day.';	}	else	{      	$ret['IsSuccess'] = false;      	$ret['Msg'] = mysql_error();	}    }	  //}	  //else	  //{		//$ret['IsSuccess'] = false;      		//$ret['Msg'] = 'Resource Not Avalaible';	  //}	}	else	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'Please select your required days.';	}	}	else	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'You have not select any batch.';	}	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function listCalendarByRange($sd, $ed){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  try{    $db = new DBConnection();    $db->getConnection();    $sql = "select * from `jqcalendar` where (`starttime` between '"      .php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."') and (`status`='1' and deleted='0') ";    $handle = mysql_query($sql);    //echo $sql;    while ($row = mysql_fetch_object($handle)) {      //$ret['events'][] = $row;      //$attends = $row->AttendeeNames;      //if($row->OtherAttendee){      //  $attends .= $row->OtherAttendee;      //}      //echo $row->StartTime;      $ret['events'][] = array(        $row->Id,        $row->Subject,        php2JsTime(mySql2PhpTime($row->StartTime)),        php2JsTime(mySql2PhpTime($row->EndTime)),        $row->IsAllDayEvent,        0, //more than one day event        //$row->InstanceType,        0,//Recurring event,        $row->Color,        1,//editable        $row->Location,         ''//$attends      );    }	}catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type){  $phpTime = js2PhpTime($day);  //echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  //echo $st . "--" . $et;  return listCalendarByRange($st, $et);}function updateCalendar($id, $st, $et){  $ret = array();  try{	    $db = new DBConnection();    $db->getConnection();	$flg=0;	$flg_in=0;	$jq_sql=mysql_fetch_array(mysql_query("select * from `jqcalendar` where id='$id'"));	$sch_sql=mysql_fetch_array(mysql_query("select * from schedules where id='$jq_sql[schedule_id]'"));	/*$checkSd=strtotime($sch_sql['start_time']);	$checkEd=strtotime($sch_sql['end_time']);	$datediff = $checkEd - $checkSd;     	$finalDateDiff=floor($datediff/(60*60*24));*/	$expValueSt=explode(" ", $sch_sql['start_time']);	$expValueEn=explode(" ", $sch_sql['end_time']);	$stDate=php2MySqlTime(js2PhpTime($st));	$enDate=php2MySqlTime(js2PhpTime($et));	if(strtotime($stDate)>=strtotime($sch_sql['start_time']) && strtotime($stDate)<=strtotime($sch_sql['end_time']))	{	/*$expValSlcStDate=explode(" ", $stDate);		$editEnd=date('Y-m-d', strtotime($expValSlcStDate[0]. ' + '.$finalDateDiff.' days'));		$finStDate=$expValSlcStDate[0]." ".$expValueSt[1];	$finEnDate=$editEnd." ".$expValueEn[1];	//$fsd=date('Y-m-d H:i:s', strtotime($finStDate));	//$fed=date('Y-m-d H:i:s', strtotime($finEnDate));	*/	$dateModified=gmdate('Y-m-d H:i:s');	$dayInWord=date('l', strtotime($stDate));	$schday=explode(",", $sch_sql[schedule_days]);	if(!(in_array($dayInWord, $schday)))	{		$schday[]=$dayInWord;		//$flg_fls=1;	}	$days = implode(',',$schday);	$sql_upd="update schedules set schedule_days='$days' , date_modified='$dateModified' where id='$jq_sql[schedule_id]'";	mysql_query($sql_upd);	$del_jq="delete from `jqcalendar` where schedule_id='$jq_sql[schedule_id]'";	mysql_query($del_jq);	foreach ($schday as $scheduleVal)	{		$endDate = strtotime($sch_sql['end_time']);				for($i = strtotime($scheduleVal, strtotime($sch_sql['start_time'])); $i <= $endDate; $i = strtotime('+1 week', $i))    	{	$place=date('Y-m-d', $i);		$preSt=$place." ".$expValueSt[1];	$preEt=$place." ".$expValueEn[1];	$finalSt=date("Y-m-d H:i:s", strtotime($preSt));	$finalEt=date("Y-m-d H:i:s", strtotime($preEt));		$sql = "insert into `jqcalendar` (`subject`, `schedule_id`, `batch_id`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"      .mysql_real_escape_string($jq_sql[Subject])."', '"      .mysql_real_escape_string($jq_sql[schedule_id])."', '"      .mysql_real_escape_string($jq_sql[batch_id])."', '"      .$finalSt."', '"      .$finalEt."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"      .mysql_real_escape_string($color)."' )";    mysql_query($sql);	$flg=1;	}	}	}	else	{		$flg_in=1;	}	if($flg==1){	$ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }else if($flg_in==1)	{      	$ret['IsSuccess'] = false;      	$ret['Msg'] = 'You have select invalid day';	//break;    	}	else	{	$ret['IsSuccess'] = false;      	$ret['Msg'] = mysql_error();	}	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function updateDetailedCalendar($id, $st, $et, $bth, $ade, $schday, $color, $tz){  $ret = array();  try{    	$db = new DBConnection();    	$db->getConnection();	$flg_top=0;	$bth_row=mysql_fetch_array(mysql_query("select * from batch where id='$bth'"));	if($bth_row['start_date']!="" || $bth_row['end_date']!="")	{	$startTimeExpVal=explode(' ',$bth_row['start_date']);	$endTimeExpVal=explode(' ',$bth_row['end_date']);	$stime=$startTimeExpVal[0]." ".$st;	$etime=$endTimeExpVal[0]." ".$et;		if($schday=="")	{		$flg_top=1;	}	if($flg_top==0)	{		$flg=0;	$flg_in=0;				$days = implode(',',$schday);	$dateModified=gmdate('Y-m-d H:i:s');/* given query	$sql = "update `jqcalendar` set"      . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "', "      . " `subject`='" . mysql_real_escape_string($sub) . "', "	  . " `batch_id`='" . mysql_real_escape_string($bth) . "', "	  . " `teacher_id`='" . mysql_real_escape_string($tch) . "', "      . " `isalldayevent`='" . mysql_real_escape_string($ade) . "', "      . " `description`='" . mysql_real_escape_string($dscr) . "', "      . " `location`='" . mysql_real_escape_string($loc) . "', "      . " `color`='" . mysql_real_escape_string($color) . "' "      . "where `id`=" . $id; */		foreach ($schday as $scheduleVal)	{		$endDate = strtotime($bth_row['end_date']);	$flg_in=1;			for($i = strtotime($scheduleVal, strtotime($bth_row['start_date'])); $i <= $endDate; $i = strtotime('+1 week', $i))    	{	$place=date('Y-m-d', $i);		$preSt=$place." ".$st;	$preEt=$place." ".$et;	$finalSt=date("Y-m-d H:i:s", strtotime($preSt));	$finalEt=date("Y-m-d H:i:s", strtotime($preEt));				    $sql = "insert into `jqcalendar` (`subject`, `schedule_id`, `batch_id`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"      .mysql_real_escape_string($bth_row['name'])."', '"      .$id."', '"      .mysql_real_escape_string($bth)."', '"      .$finalSt."', '"      .$finalEt."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"      .mysql_real_escape_string($color)."' )";		mysql_query($sql);	$idArr[]=mysql_insert_id();    //echo($sql);	$flg=1;	}	}	 //echo $sql;      	if($flg==1)	{	$finlIdArr= implode(',',$idArr);	$del_sql="delete from jqcalendar where schedule_id='$id' and Id NOT IN ($finlIdArr)";	mysql_query($del_sql);	$sql_in_sch = "update `schedules` set"      . " `batch_id`='" . mysql_real_escape_string($bth) . "', "	  . " `schedule_days`='" .$days. "', "	  . " `start_time`='" .$stime. "', "      . " `end_time`='" .$etime. "', "      . " `date_modified`='" .$dateModified. "' "      . "where `id`=" . $id;	mysql_query($sql_in_sch);      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';          }else{	if($flg_in==1)	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'You have select invalid day.';	}	else	{	$ret['IsSuccess'] = false;     	$ret['Msg'] = mysql_error();      	}    	}	}	else	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'Please select your required days.';	}	}	else	{		$ret['IsSuccess'] = false;      		$ret['Msg'] = 'You have not select any batch.';	}	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();	$sch_sql=mysql_fetch_array(mysql_query("select * from `jqcalendar` where id='$id'"));	$del_sql="delete from schedules where id='$sch_sql[schedule_id]'";	mysql_query($del_sql);	    $sql = "delete from `jqcalendar` where `schedule_id`=" . $sch_sql[schedule_id];		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function undoDragedEvent($id){$ret = array();  try{    $db = new DBConnection();    $db->getConnection();	$flg=0;	$jq_sql=mysql_fetch_array(mysql_query("select * from `jqcalendar` where id='$id'"));	$sch_sql=mysql_eftch_array(mysql_query("select * from schedules where id='$jq_sql[schedule_id]'"));	$bth_row=mysql_fetch_array(mysql_query("select * from batch where id='$sch_sql[batch_id]'"));	$startTimeExpVal=explode(' ',$sch_sql['start_time']);	$endTimeExpVal=explode(' ',$sch_sql['end_time']);	$st=$startTimeExpVal[1];	$et=$endTimeExpVal[1];		$schDaysExpVal=explode(",", $sch_sql['schedule_days']);		foreach($schDaysExpVal as $val)	{		$delDay=$val;	}	$d_sql = "delete from `jqcalendar` where `schedule_id`='$jq_sql[schedule_id]'";	mysql_query($d_sql);	foreach($schDaysExpVal as $scheduleVal)	{		if($scheduleVal!=$delDay)		{		$newSchDays[]=$scheduleVal;		$endDate = strtotime($bth_row['end_date']);				for($i = strtotime($scheduleVal, strtotime($bth_row['start_date'])); $i <= $endDate; $i = strtotime('+1 week', $i))    		{		$place=date('Y-m-d', $i);			$preSt=$place." ".$st;		$preEt=$place." ".$et;		$finalSt=date("Y-m-d H:i:s", strtotime($preSt));		$finalEt=date("Y-m-d H:i:s", strtotime($preEt));				    		$sql = "insert into `jqcalendar` (`subject`, `schedule_id`, `batch_id`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"      .mysql_real_escape_string($bth_row['name'])."', '"      .$sch_sql['id']."', '"      .mysql_real_escape_string($sch_sql['batch_id'])."', '"      .$finalSt."', '"      .$finalEt."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"      .mysql_real_escape_string($color)."' )";			mysql_query($sql);		//$idArr[]=mysql_insert_id();    		//echo($sql);		$flg=1;	}	}	}	if($flg==1)	{					$ret['IsSuccess'] = true;      		$ret['Msg'] = 'Succefully';		   	}else{	$ret['IsSuccess'] = false;      	$ret['Msg'] = mysql_error();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];switch ($method) {    case "add":        $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);        break;    case "list":        $ret = listCalendar($_POST["showdate"], $_POST["viewtype"]);        break;    case "update":        $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);        break;     case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        break;    case "undo":        $ret = undoDragedEvent( $_POST["calendarId"]);        break;    case "adddetails":        $st = $_POST["stpartdate"] . " " . $_POST["stparttime"];        $et = $_POST["etpartdate"] . " " . $_POST["etparttime"];        if(isset($_GET["id"])){            $ret = updateDetailedCalendar($_GET["id"], $_POST["stparttime"], $_POST["etparttime"], $_POST["Batch"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["scheduleDays"], $_POST["colorvalue"], $_POST["timezone"]);        }else{            $ret = addDetailedCalendar($_POST["stparttime"], $_POST["etparttime"], $_POST["Batch"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["scheduleDays"], $_POST["colorvalue"], $_POST["timezone"]);        }                break; }echo json_encode($ret); ?>